<!DOCTYPE html>
<html lang="en" style="height: 100%; margin: 0">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-4DHJEMESJD"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(...args) {
        window.dataLayer.push(args);
      }
      gtag('js', new Date());

      gtag('config', 'G-4DHJEMESJD');
    </script>
    <!-- Google tag end -->
    <title>Bubblesets - Example</title>
    <link rel="canonical" href="https://bubblesets-js.josuakrause.com/" />
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <h3>Bubblesets for JavaScript</h3>
    <p>
      Add rectangles by clicking with the left or right mouse button on the
      canvas.
    </p>
    <svg id="main">
      <rect
        x="0"
        y="0"
        width="100%"
        height="100%"
        style="stroke: black; stroke-width: 1; fill: none"
      ></rect>
    </svg>

    <script type="module" id="jsmain" defer>
      import {
        BubbleSet,
        PointPath,
        ShapeSimplifier,
        BSplineShapeGenerator,
      } from './bubblesets.js';

      function attr(elem, attr) {
        for (const key of Object.keys(attr)) {
          const value = attr[key];
          if (value === null) {
            elem.removeAttribute(key);
          } else {
            elem.setAttribute(key, value);
          }
        }
      }

      function style(elem, style) {
        for (const key of Object.keys(style)) {
          const value = style[key];
          if (value === null) {
            delete elem.style.removeProperty(key);
          } else {
            elem.style.setProperty(key, value);
          }
        }
      }

      function appendSVG(parent, name) {
        return parent.appendChild(
          document.createElementNS('http://www.w3.org/2000/svg', name),
        );
      }

      function removeAllChilds(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild);
        }
      }

      function start() {
        const bubbles = new BubbleSet();
        const rectanglesA = [];
        const rectanglesB = [];
        const main = document.getElementById('main');
        const items = appendSVG(main, 'g');
        const pathA = appendSVG(main, 'path');
        const pathB = appendSVG(main, 'path');
        const debug = appendSVG(main, 'g');
        bubbles.debug(true);
        const debugFor = pathA;

        function update() {
          updateOutline(rectanglesA, rectanglesB, 'crimson', pathA);
          updateOutline(rectanglesB, rectanglesA, 'cornflowerblue', pathB);
        }

        function updateOutline(rectangles, otherRectangles, color, path) {
          const pad = 5;
          const list = bubbles.createOutline(
            BubbleSet.addPadding(rectangles, pad),
            BubbleSet.addPadding(otherRectangles, pad),
            null /* lines */,
          );
          console.log(list);
          // rectangles need to have the form { x: 0, y: 0, width: 0, height: 0 }
          // lines need to have the form { x1: 0, x2: 0, y1: 0, y2: 0 }
          // lines can be null to infer lines between rectangles automatically
          const outline = new PointPath(list).transform([
            new ShapeSimplifier(0.0),
            new BSplineShapeGenerator(),
            new ShapeSimplifier(0.0),
          ]);
          console.log(outline);
          // outline is a path that can be used for the attribute d of a path element
          attr(path, {
            d: outline,
            opacity: 0.5,
            fill: color,
            stroke: 'black',
          });
          if (bubbles.debug() && path === debugFor) {
            removeAllChilds(debug);
            bubbles.debugPotentialArea().forEach((r) => {
              const rect = appendSVG(debug, 'rect');
              attr(rect, {
                x: r.x,
                y: r.y,
                width: r.width,
                height: r.height,
              });
              const color =
                r.value === r.threshold
                  ? '0, 0, 0'
                  : r.value > 0
                  ? '150, 20, 20'
                  : '20, 20, 150';
              style(rect, {
                fill: `rgb(${color})`,
                opacity:
                  r.value === r.threshold
                    ? 0.5
                    : Math.min(255, Math.abs(r.value * 40)) / 255.0,
              });
            });
          }
        }

        function addRect(rectangles, color, cx, cy) {
          const width = 40;
          const height = 30;
          const x = cx - width * 0.5;
          const y = cy - height * 0.5;
          const elem = appendSVG(items, 'rect');
          attr(elem, {
            x: x,
            y: y,
            width: width,
            height: height,
          });
          style(elem, {
            stroke: 'black',
            'stroke-width': 1,
            fill: color,
          });
          rectangles.push({
            x: x,
            y: y,
            width: width,
            height: height,
            elem: elem,
          });
          update();
        }

        main.addEventListener('click', (e) => {
          addRect(rectanglesA, 'cornflowerblue', e.offsetX, e.offsetY);
        });
        let oldX = Number.NaN;
        let oldY = Number.NaN;
        main.addEventListener('contextmenu', (e) => {
          if (oldX === e.offsetX && oldY === e.offsetY) return;
          oldX = e.offsetX;
          oldY = e.offsetY;
          addRect(rectanglesB, 'crimson', e.offsetX, e.offsetY);
          e.preventDefault();
        });
      }

      start();
    </script>
    <footer>
      <div class="footer-style">
        Â© jk 2024
        <a href="https://github.com/JosuaKrause/bubblesets-js" target="_blank">
          [source]
        </a>
      </div>
    </footer>
  </body>
</html>
